"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("fs")),n=e(require("glob")),r=e(require("lodash.clonedeep")),o=e(require("lodash.merge")),i=e(require("fs-extra")),s=require("common-tags"),u=e(require("nunjucks"));let a=process.env.NODE_ENV;function c(e){return e&&"object"==typeof e&&e.constructor===Array}function l(e){return h(e)&&""===e||c(e)&&0===e.length||d(e)&&0===Object.keys(e).length}function f(e){return e instanceof Error&&void 0!==e.message}function m(e){return null==e}function p(e){return null==e||void 0===e}function d(e){return e&&"object"==typeof e&&e.constructor===Object}function h(e){return"string"==typeof e||e instanceof String}function g(e){return void 0===e||void 0===e}const b={arr:c,bad:function(e){return m(e)||g(e)||l(e)||f(e)},bool:function(e){return"boolean"==typeof e},date:function(e){return e instanceof Date},empty:l,err:f,fn:function(e){return"function"==typeof e},inte:function(e){return"number"==typeof e&&isFinite(e)&&Number.isInteger(e)},json:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},nll:m,noru:p,num:function(e){return"number"==typeof e&&isFinite(e)},obj:d,file:function(e){return/\/\w+$|\w+\.\w+$/im.test(e)},dir:function(e){return/^\.?\/?(\w+\/)+/im.test(e)},path:function(e){return/\/|\./im.test(e)},prom:function(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e.then},regex:function(e){return e&&"object"==typeof e&&e.constructor===RegExp},str:h,sym:function(e){return"symbol"==typeof e},typa:function(e,t,n,r){if(p(e)||p(t)||p(n)||p(r))throw new Error("Invalid parameters.");return b[e](t)?n:r},undef:g,what:function(e){let t=[];if([{fn:"arr",name:"array"},{fn:"bool",name:"boolean"},{fn:"date",name:"date"},{fn:"err",name:"error"},{fn:"fn",name:"function"},{fn:"inte",name:"integer"},{fn:"json",name:"json"},{fn:"nll",name:"null"},{fn:"num",name:"number"},{fn:"obj",name:"object"},{fn:"file",name:"file"},{fn:"dir",name:"dir"},{fn:"path",name:"path"},{fn:"prom",name:"promise"},{fn:"regex",name:"regexp"},{fn:"str",name:"string"},{fn:"sym",name:"symbol"},{fn:"undef",name:"undefined"}].forEach(n=>{b[n.fn](e)&&t.push(n.name)}),b.noru(e))throw new Error("Missing value to test.");return t[0]}};const y=new class{clone(e){Object.assign(this,r(e))}update(e){Object.assign(this,e)}},w=require("@unboundedsystems/jsonnet"),j=/([a-zA-Z0-9\s_\\.\-\(\):])+(.js)$/im,v=/([a-zA-Z0-9\s_\\.\-\(\):])+(.jsonnet)$/im;const O=new class{constructor(){return this}set(e,r){let i;if("path"===b.what(e)||"file"===b.what(e)||"dir"===b.what(e)){let r=function(e,t){let r,o="";"dir"===b.what(t)&&(r=n.sync(process.cwd()+"/"+t+"**/*"));"file"===b.what(t)&&(r=n.sync(process.cwd()+"/"+t));return r.map((function(e){(j.test(e)||v.test(e))&&(o=e)})),o}(0,e);if(j.test(r)&&(i=require(file)),v.test(r)){const e=t.readFileSync(r).toString(),n=new w.Jsonnet;i=n.eval(e),n.destroy()}}else i="object"===b.what(e)?e:{};O.result&&(i=Object.assign(O.result,i)),o(this,i),y.clone(O)}};const $=new class{constructor(){return this}set(e){let t;if("string"==typeof e&&i.existsSync(process.cwd()+"/"+e)&&(t=require(process.cwd()+"/"+e)),"object"==typeof e&&(t=e),t){let n={},r="";e.match(/(.*)[\/\\]/)&&(r=e.match(/(.*)[\/\\]/)[1]+"/"),n.root=process.cwd()+"/"+r||"",n.rootOnly=r,n.path=process.cwd()+"/"+e,n=Object.assign(n,t),["model","template","output"].forEach((function(e){n[e]&&(n[e]=function(e){return Array.isArray(e)?e:[e]}(n[e]))})),n=function(e){let t=e.output.map((function(t){if(void 0===t)throw new Error("No outputs specified in config");let n,r,o,i,s;return n=void 0===t.file?Object.keys(t)[0]:null,r=t.model?t.model:e.model?e.model:null,o=t.template?t.template:e.template?e.template:null,i=t.dir?e.dir?e.root+e.dir+t.dir:e.root+t.dir:e.dir?e.root+e.dir:e.root+"",s=void 0===t.file?t[n].file:t.file,Object.assign({},{name:n,model:r,template:o,dir:i,file:s})}));return e.output=t,e}(n),n.theme&&O.set(n.rootOnly+n.theme,n),Object.assign(this,n)}}};"test"===a?$.set("src/stub/config.js"):$.set("mole.config.js");const q=new class{constructor(){this.model=[],this.template=[]}};var x="";function S(e,...t){if(e){let n="";return e.forEach((e,r)=>{if("object"==typeof t[r]&&null!==t[r]){var{prefix:o,side:i,i:s,abbr:u}=t[r];(o||u)&&i&&s&&(t[r]=`[${o||u}-${i}~="${s}"]`),(o||u)&&s?t[r]=`[${o||u}~="${s}"]`:(o||u)&&i?t[r]=`[${o||u}-${i}]`:(o||u)&&(t[r]=`[${o||u}]`)}n+=e+(t[r]||"")}),n=s.stripIndent(n),void 0!==x&&(x+=n+"\n"),n}return void 0!==x?x:str}class E{constructor(e,t,n,o,i){(function e(t){var n=Object.getOwnPropertyNames(t);for(let r of n){let n=t[r];t[r]=n&&"object"==typeof n?e(n):n}return Object.freeze(t)})(n=r(n)),this.name=e,this.active=i,this.string=t(o,n,e,S)}}class F{constructor(e,t,n,o,i){this.name=e,this.active=i,o=r(o),this.data=t(n,o)}}class k{constructor(e,t,n,r,o){Object.assign(this,{name:e.name,...A(e,t,n,r,o),path:e.dir+e.file})}}function A(e,t,n,r,i){let s={};for(let u in t)if(null===e.model&&(e[u]=i),null===e.template&&(e[u]=["xxxxx"]),e[u]){let a=[];for(let o in e[u])switch(b.what(e[u][o])){case"dir":a.push(N(e[u][o],e,t,u,n,r,i));break;case"file":a.push(_(e[u][o],u,n,r,i));break;case"string":if(t[u])if(t[u].length>0)for(let n of t[u])e[u][o]===n.name&&(n.active=!0),n.active&&a.push(n.data||n.string);else a.push(i);else console.log(`No ${u}s named '${e[u][o]}', please check`);break;default:a.push(e[u])}"model"===u&&(s[u]=o(...a)),"template"===u&&(s[u]=a.join("\n"))}return s}function N(e,t,r,s,u,a,c){let l=[];l=Object.keys(c),l.push("index"),l=l.join("|");let f=[];if(i.existsSync(u.root+e+t.name+"/")){let r=n.sync(u.root+e+t.name+"/@("+l+")*");for(let e of r)if(/\.js$/gim.test(e)){if("model"===s){let t=new F("name",require(e),a,c);f.push(t.data),c.update(t.data)}"template"===s&&f.push(new E("name",require(e),a,c).string)}else f.push(i.readFileSync(e,"utf8"))}else{let r=n.sync(u.root+e+t.name+"*");for(let e of r)if(/\.js$/gim.test(e)){if("model"===s){let t=new F("name",require(e),a,c);f.push(t.data),c.update(t.data)}"template"===s&&f.push(new E("name",require(e),a,c).string)}else f.push(i.readFileSync(e,"utf8"))}return"model"===s?o(...f):"template"===s?f.join("\n"):void 0}function _(e,t,n,r,o){if(!/\.js$/gim.test(e))return i.readFileSync(n.root+e,"utf8");if("model"===t){let t=new F("name",require(n.root+e),r,o);return o.update(t.data),t.data}return"template"===t?new E("name",require(n.root+e),r,o).string:void 0}const z=u.configure();let I=[];const D=new class{constructor(){}config(e){$.set(e)}theme(e){O.set(e,$)}register(...e){if(e[0]&&(e=e[0]),"model"===e[0]){let t=new F(e[1],e[2],O,y);q.model.push(t),y.update(t.data)}"template"===e[0]&&q.template.push(new E(e[1],e[2],O,y)),this._outputs()}use(...e){var t;if(Array.isArray(e[0])&&(e=e[0]),(t=e[0])&&"[object Function]"==={}.toString.call(t)&&(e=e[0]()),"model"===e[0]){let t=new F(e[1],e[2],O,y,!0);q.model.push(t),y.update(t.data)}"template"===e[0]&&q.template.push(new E(e[1],e[2],O,!0,!0)),this._outputs()}create(...e){this.register(...e)}add(...e){this.create(...e)}_outputs(){I=$.output.map(e=>new k(e,q,$,O,y))}render(){let e=[];for(let t of I){let n={content:z.renderString(t.template,t.model),path:t.path};e.push(n)}return e}build(){this._outputs();for(let e of this.render())i.outputFile(e.path,e.content,(function(t){t&&console.log(t),"test"===a&&i.readFile(e.path,"utf8",(function(e,t){console.log(t)}))}))}};"test"===a&&D.build(),D.debug={config:$,theme:O,data:y,outputs:$.output,files:[],things:I},module.exports=D;
//# sourceMappingURL=index.js.map
