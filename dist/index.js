"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("fs")),n=e(require("glob")),r=e(require("lodash.clonedeep")),o=e(require("lodash.merge")),s=e(require("fs-extra")),i=e(require("nunjucks"));let u=process.env.NODE_ENV;function a(e){return e&&"object"==typeof e&&e.constructor===Array}function c(e){return d(e)&&""===e||a(e)&&0===e.length||p(e)&&0===Object.keys(e).length}function l(e){return e instanceof Error&&void 0!==e.message}function f(e){return null==e}function m(e){return null==e||void 0===e}function p(e){return e&&"object"==typeof e&&e.constructor===Object}function d(e){return"string"==typeof e||e instanceof String}function h(e){return void 0===e||void 0===e}const g={arr:a,bad:function(e){return f(e)||h(e)||c(e)||l(e)},bool:function(e){return"boolean"==typeof e},date:function(e){return e instanceof Date},empty:c,err:l,fn:function(e){return"function"==typeof e},inte:function(e){return"number"==typeof e&&isFinite(e)&&Number.isInteger(e)},json:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},nll:f,noru:m,num:function(e){return"number"==typeof e&&isFinite(e)},obj:p,file:function(e){return/\/\w+$|\w+\.\w+$/im.test(e)},dir:function(e){return/^\.?\/?(\w+\/)+/im.test(e)},path:function(e){return/\/|\./im.test(e)},prom:function(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e.then},regex:function(e){return e&&"object"==typeof e&&e.constructor===RegExp},str:d,sym:function(e){return"symbol"==typeof e},typa:function(e,t,n,r){if(m(e)||m(t)||m(n)||m(r))throw new Error("Invalid parameters.");return g[e](t)?n:r},undef:h,what:function(e){let t=[];if([{fn:"arr",name:"array"},{fn:"bool",name:"boolean"},{fn:"date",name:"date"},{fn:"err",name:"error"},{fn:"fn",name:"function"},{fn:"inte",name:"integer"},{fn:"json",name:"json"},{fn:"nll",name:"null"},{fn:"num",name:"number"},{fn:"obj",name:"object"},{fn:"file",name:"file"},{fn:"dir",name:"dir"},{fn:"path",name:"path"},{fn:"prom",name:"promise"},{fn:"regex",name:"regexp"},{fn:"str",name:"string"},{fn:"sym",name:"symbol"},{fn:"undef",name:"undefined"}].forEach(n=>{g[n.fn](e)&&t.push(n.name)}),g.noru(e))throw new Error("Missing value to test.");return t[0]}};const y=new class{clone(e){Object.assign(this,r(e))}update(e){Object.assign(this,e)}},b=require("@unboundedsystems/jsonnet"),w=/([a-zA-Z0-9\s_\\.\-\(\):])+(.js)$/im,j=/([a-zA-Z0-9\s_\\.\-\(\):])+(.jsonnet)$/im;const O=new class{constructor(){return this}set(e,r){let s;if("path"===g.what(e)||"file"===g.what(e)||"dir"===g.what(e)){let r=function(e,t){let r,o="";"dir"===g.what(t)&&(r=n.sync(process.cwd()+"/"+t+"**/*"));"file"===g.what(t)&&(r=n.sync(process.cwd()+"/"+t));return r.map((function(e){(w.test(e)||j.test(e))&&(o=e)})),o}(0,e);if(w.test(r)&&(s=require(file)),j.test(r)){const e=t.readFileSync(r).toString(),n=new b.Jsonnet;s=n.eval(e),n.destroy()}}else s="object"===g.what(e)?e:{};O.result&&(s=Object.assign(O.result,s)),o(this,s),y.clone(O)}};const q=new class{constructor(){return this}set(e){let t;if("string"==typeof e&&s.existsSync(process.cwd()+"/"+e)&&(t=require(process.cwd()+"/"+e)),"object"==typeof e&&(t=e),t){let n={},r="";e.match(/(.*)[\/\\]/)&&(r=e.match(/(.*)[\/\\]/)[1]+"/"),n.root=process.cwd()+"/"+r||"",n.rootOnly=r,n.path=process.cwd()+"/"+e,n=Object.assign(n,t),["model","template","output"].forEach((function(e){n[e]&&(n[e]=function(e){return Array.isArray(e)?e:[e]}(n[e]))})),n=function(e){let t=e.output.map((function(t){if(void 0===t)throw new Error("No outputs specified in config");let n,r,o,s,i;return n=void 0===t.file?Object.keys(t)[0]:null,r=t.model?t.model:e.model?e.model:null,o=t.template?t.template:e.template?e.template:null,s=t.dir?e.dir?e.root+e.dir+t.dir:e.root+t.dir:e.dir?e.root+e.dir:e.root+"",i=void 0===t.file?t[n].file:t.file,Object.assign({},{name:n,model:r,template:o,dir:s,file:i})}));return e.output=t,e}(n),n.theme&&O.set(n.rootOnly+n.theme,n),Object.assign(this,n)}}};"test"===u?q.set("src/stub/config.js"):q.set("mole.config.js");const v=new class{constructor(){this.model=[],this.template=[]}};class S{constructor(e,t,n,o){(function e(t){var n=Object.getOwnPropertyNames(t);for(let r of n){let n=t[r];t[r]=n&&"object"==typeof n?e(n):n}return Object.freeze(t)})(n=r(n)),this.name=e,this.string=t(n,o)}}class x{constructor(e,t,n,o){this.name=e,o=r(o),this.data=t(n,o)}}class E{constructor(e,t,n,r,o){Object.assign(this,{name:e.name,...$(e,t,n,r,o),path:e.dir+e.file})}}function $(e,t,n,r,s){let i={};for(let u in t)if(null===e[u]&&(e[u]=s),e[u]){let a=[];for(let o in e[u])switch(g.what(e[u][o])){case"dir":a.push(k(e[u][o],e,t,u,n,r,s));break;case"file":a.push(F(e[u][o],u,n,r,s));break;case"string":if(t[u])if(t[u].length>0)for(let n of t[u])e[u][o]===n.name&&a.push(n.data||n.string);else a.push(s);else console.log(`No ${u}s named '${e[u][o]}', please check`);break;default:a.push(e[u])}"model"===u&&(i[u]=o(...a)),"template"===u&&(i[u]=a.join("\n"))}return i}function k(e,t,r,i,u,a,c){let l=[];l=Object.keys(c),l.push("index"),l=l.join("|");let f=[];if(s.existsSync(u.root+e+t.name+"/")){let r=n.sync(u.root+e+t.name+"/@("+l+")*");for(let e of r)if(/\.js$/gim.test(e)){if("model"===i){let t=new x("name",require(e),a,c);f.push(t.data),c.update(t.data)}"template"===i&&f.push(new S("name",require(e),a,c).string)}else f.push(s.readFileSync(e,"utf8"))}else{let r=n.sync(u.root+e+t.name+"*");for(let e of r)if(/\.js$/gim.test(e)){if("model"===i){let t=new x("name",require(e),a,c);f.push(t.data),c.update(t.data)}"template"===i&&f.push(new S("name",require(e),a,c).string)}else f.push(s.readFileSync(e,"utf8"))}return"model"===i?o(...f):"template"===i?f.join("\n"):void 0}function F(e,t,n,r,o){if(!/\.js$/gim.test(e))return s.readFileSync(n.root+e,"utf8");if("model"===t){let t=new x("name",require(n.root+e),r,o);return o.update(t.data),t.data}return"template"===t?new S("name",require(n.root+e),r,o).string:void 0}const N=i.configure();let _=[];const A=new class{constructor(){}config(e){q.set(e)}theme(e){O.set(e,q)}create(...e){if("model"===e[0]){let t=new x(e[1],e[2],O,y);v.model.push(t),y.update(t.data)}"template"===e[0]&&v.template.push(new S(e[1],e[2],O,y)),this._outputs()}add(...e){this.create(...e)}_outputs(){_=q.output.map(e=>new E(e,v,q,O,y))}render(){let e=[];for(let t of _){let n={content:N.renderString(t.template,t.model),path:t.path};e.push(n)}return e}build(){this._outputs();for(let e of this.render())s.outputFile(e.path,e.content,(function(t){t&&console.log(t),"test"===u&&s.readFile(e.path,"utf8",(function(e,t){console.log(t)}))}))}};"test"===u&&A.build(),A.debug={config:q,theme:O,data:y,outputs:q.output,files:[],things:_},module.exports=A;
//# sourceMappingURL=index.js.map
